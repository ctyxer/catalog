<%- include('particles/header.ejs') %>

<%- include('particles/navigation.ejs') %>

<% if(item.author == username) { %>
<div class="rounded-md border-4 border-black p-1 m-1 w-min ml-auto">
  <a href="/items/<%= item.id %>/change">change</a>
</div>
<% } %>

<div name="item" class="rounded-md border-4 border-black p-3 m-1">
  <img class="inline-block rounded-2xl max-h-60 max-w-60 pr-2" src="../img/<%= item.image %>" />
  <div class="inline-block">
    <h2 class="text-lg font-bold mb-auto">
      <%= item.title %>
    </h2>
    <p href="/users/<%= item.author %>" class="mr-auto">
      Author - <%= item.author %>
    </p>
    <p href="/users/<%= item.author %>" class="mr-auto">
      Category - <%= item.category.name %>
    </p>
    <p class="text-gray-600">
      Created - <%= item.date_creating %>
    </p>
  </div>
</div>

<div class="rounded-md border-4 border-black p-3 m-1">
  <p>
    Description:
  </p>
  <p class="font-bold">
    <%= item.description %>
  </p>
</div>

<p class="font-bold m-5"><%if(item.comments.length==0){%>No <%}else%>Commentaries<% {%>:<%}%></p>

<div id="comments"></div>

<% for (let i = 0; i < item.comments.length; i++) { %>

<div class="rounded-md border-4 border-black p-3 m-1">
  <p class="text-blue-900 font-bold">
    <%=item.comments[i].author%>
  </p>

  <p class="bg-blue-200 rounded-md p-1">
    <%=item.comments[i].commentary%>
  </p>
  <p class="text-xs inline-block">
    Created - <%=item.comments[i].date_creating%>
  </p>
  <% if(item.comments[i].author == username){ %>
  <form action="/deleteCommentary" method="post" class="text-red-600 font-bold inline-block ml-auto">
    <input type="hidden" value="<%=item.comments[i].id%>" type="text" name="idComment">
    <input type="hidden" value="<%= item.id %>" type="text" name="id">
    <input type="submit" class="form-button" value="Удалить">
  </form>
  <% } %>
</div>
<% } %>
<button onclick='getComments()'>
  Get Comments
</button>
<script>
  let skip = 0;

  function getComments(skip = 0) {
    fetch(`http://localhost:5000/comment/<%= item.id %>/${skip}`, {
        method: 'GET',
        headers: {
          'Access-Control-Allow-Origin': 'http://localhost:5000',
        },
      })
      .then((response) => {
        console.log(response);
        return response.json();
      })
      .then((data) => {
        console.log(data)
        document.getElementById('comments').innerHTML =
          `<div class="rounded-md border-4 border-black p-3 m-1">
  <p class="text-blue-900 font-bold">
    ${data.author}
  </p>
  <p class="bg-blue-200 rounded-md p-1">
    ${data.commentary}
  </p>
  <p class="text-xs inline-block">
    Created - ${data.date_creating}
  </p>
</div>`;
        skip = skip + 20;
      })

  }
</script>

<% if(auth) { %>
<form action="/addCommentary" method="post">

  <div class="m-4 border-4 border-black rounded-md ml-1 mr-1 p-4">
    <p class="font-bold mb-2">Add commentary</p>
    <span>
      <input type="text" name="commentary" class="inline-block border-2 border-black rounded w-full">
      <input type="hidden" value="<%= item.id %>" type="text" name="id">
      <input type="submit" class="border-4 border-black rounded-md mt-2" value="Upload">
    </span>
  </div>
</form>
<% } %>

<%- include('particles/footer.ejs') %>